<!--題目-->
<!--https://www.itsa.org.tw/itsacontest/2024/prefile/2019%E5%B9%B4ITSA%E5%85%A8%E5%9C%8B%E5%A4%A7%E5%B0%88%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88%E6%A5%B5%E5%AE%A2%E6%8C%91%E6%88%B0%E8%B3%BD-%E8%B3%87%E8%A8%8A%E7%B3%BB%E7%B5%B1%E8%88%87%E7%B6%B2%E9%A0%81%E8%A8%AD%E8%A8%88%E6%87%89%E7%94%A8%E7%B5%84(%E5%88%9D%E8%B3%BD%E8%A9%A6%E9%A1%8C).pdf-->
<!--https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/input/file-->
<!--https://ithelp.ithome.com.tw/m/articles/10299106-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" >
    <title>題目四：處理影像檔</title>
</head>
<body>

    <div id="overview">
        <!--檔案的格式可以是 jpg, png, gif-->
        <input id="file" type="file" value="選擇檔案" onchange="checkpicture()" > <!--原本要限制導入圖片 但是題目有規定 導入不是圖片的東西時需要給他回饋-->
        <a id="download">下載圖片</a>
    </div>

<script>

imageType="";

function checkpicture(){ 
//紀錄bug 能夠讀取檔案並且 跳出視窗 但是檔案還是會進去 不知道是不是一定會進去 或是 可以忽略這部分
    let file = document.getElementById('file');
    file = file.files[0];

    if (!file.type.startsWith("image/png") &&
        !file.type.startsWith("image/gif") &&
        !file.type.startsWith("image/jpeg")) {
        alert("不支援此檔案格式!");//題目要求的
        file.value = ""; //bug解除使用 value去壤不要的檔案讀進來
        console.log(file.type);
    }
    else{
        imageType = file.type;
        readfile(file);
    }
}

function readfile(file){
    let reader = new FileReader(); //創建一個 FileReader 用來讀取文件 https://developer.mozilla.org/zh-TW/docs/Web/API/FileReader
    reader.readAsArrayBuffer(file); 
    reader.onload = function (event){
        let blob = new Blob([event.target.result]);
        window.URL = window.URL || window.webkitURL;
        let blobURL =window.URL.createObjectURL(blob);

        let image = new Image();
        image.src = blobURL;
        image.onload = function() {
            console.log(image);
            newImage = compressionpic(image); 
            setDownload(newImage);
        }
    }
}

function compressionpic(image){
    let canvas = document.createElement('canvas');
    canvas.width = image.width;
    canvas.height = image.height;
    console.log(canvas.height);
    while(canvas.width>1000||canvas.height>1000){
        canvas.width = canvas.width*0.5;
        canvas.height = canvas.height*0.5;
        console.log(canvas.width,canvas.height);
    }
    //let ctx = canvas.getContext("2d");
    //ctx.drawImage(image, 0, 0, canvas.width, canvas.height); // 把圖片畫在畫布上(0,0)作標到(canvas.width,canvas.height)

    let newImg = canvas.toDataURL(imageType, 0.8); // 0.8是圖片壓縮比
    //console.log("compressionpic觸發")
    return newImg;
}

function setDownload(newImg) {
    let download = document.getElementById("download");
    let fileName = imageType.replace('/', '.');

    download.setAttribute("download", fileName);
    download.setAttribute("href", newImg);
}

</script>
</body>
</html>